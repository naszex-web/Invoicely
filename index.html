<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f1f5f9">
    
    <title>NASZEX CLOUD - RMS PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #f1f5f9; --glass-border: rgba(255, 255, 255, 0.7); }
        * { -webkit-tap-highlight-color: transparent !important; outline: none !important; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-color); color: #0f172a; 
            user-select: none; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased;
        }
        
        .font-num { font-family: 'Inter', sans-serif; }
        .gpu { transform: translate3d(0,0,0); backface-visibility: hidden; perspective: 1000px; will-change: transform, opacity; }

        /* UI Components */
        .neo-glass { background: rgba(255, 255, 255, 0.55); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--glass-border); box-shadow: 6px 6px 16px rgba(15, 23, 42, 0.04), -6px -6px 16px rgba(255, 255, 255, 0.8), inset 1px 1px 2px rgba(255, 255, 255, 0.4); }
        .neo-inset { background: rgba(241, 245, 249, 0.5); box-shadow: inset 3px 3px 6px rgba(15, 23, 42, 0.04), inset -3px -3px 6px rgba(255, 255, 255, 0.9); border: 1px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .neo-inset:focus-within { border-color: rgba(99, 102, 241, 0.5); background: #ffffff; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08); }
        .neo-button { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); box-shadow: 4px 4px 10px rgba(15, 23, 42, 0.05), -4px -4px 10px rgba(255, 255, 255, 1); border: 1px solid white; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .neo-button:active { box-shadow: inset 2px 2px 5px rgba(15, 23, 42, 0.05), inset -2px -2px 5px rgba(255, 255, 255, 1); transform: scale(0.97); }
        .ios-glass { background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.7); box-shadow: 0 8px 32px rgba(15, 23, 42, 0.04), inset 0 1px 1px rgba(255, 255, 255, 0.9), inset 0 -1px 1px rgba(255, 255, 255, 0.4); transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), background 0.2s; }
        .ios-glass:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.6); }

        .gradient-text { background: linear-gradient(135deg, #0f172a 0%, #4f46e5 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card-gradient-1 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.3); }

        /* Background Pattern for Lock Screen */
        .bg-pattern { background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px); background-size: 24px 24px; }

        /* Animations & Transitions */
        .modal-overlay { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.4s ease; z-index: 60; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-wrapper { transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease; transform: translateY(100%) scale(0.98); opacity: 0; pointer-events: none; will-change: transform, opacity; z-index: 100; }
        .modal-wrapper.active { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
        
        .view-section { display: none; opacity: 0; }
        .view-section.active { display: block; animation: fadeInView 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInView { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        
        .list-anim { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .tap-effect { transition: transform 0.1s; cursor: pointer; }
        .tap-effect:active { transform: scale(0.95); }
        .tab-active { background: #1e293b !important; color: #fff !important; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15); }
        .nav-item-active { color: #4f46e5 !important; font-weight: 800; }

        /* Inputs */
        .float-input-group { position: relative; width: 100%; transition: 0.3s; }
        .float-input-group label { position: absolute; top: 10px; left: 16px; font-size: 9px; font-weight: 800; color: #64748b; text-transform: uppercase; pointer-events: none; letter-spacing: 0.05em; transition: 0.2s; }
        .float-input-group input, .float-input-group select { padding-top: 26px; padding-bottom: 10px; }
        
        /* Toast */
        #toast-container { position: fixed; top: max(20px, env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); color: #0f172a; border: 1px solid rgba(255,255,255,1); padding: 14px 24px; border-radius: 99px; font-size: 12px; font-weight: 700; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: toastIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; opacity: 0; display: flex; align-items: center; gap: 10px; will-change: transform, opacity; }
        .toast.out { animation: toastOut 0.3s forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes toastOut { to { opacity: 0; transform: translateY(-10px) scale(0.95); } }

        /* Nav & Utilities */
        .floating-nav { position: fixed; bottom: max(1rem, env(safe-area-inset-bottom)); left: 1rem; right: 1rem; border-radius: 2rem; padding: 0.5rem 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sync-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="toast-container"></div>
    <div id="modalBackdrop" class="fixed inset-0 modal-overlay z-50 hidden"></div>

    <div id="authScreen" class="fixed inset-0 z-[100] bg-[#f1f5f9] flex flex-col items-center justify-center px-6 transition-opacity duration-700">
        <div class="absolute inset-0 bg-pattern opacity-50"></div>
        
        <div class="neo-glass p-8 rounded-[2rem] w-full max-w-sm relative z-10 text-center shadow-2xl border border-white/80">
            <div class="w-20 h-20 mx-auto bg-indigo-50 rounded-2xl flex items-center justify-center border border-indigo-100 mb-6 shadow-inner">
                <i data-lucide="lock" class="w-10 h-10 text-indigo-500"></i>
            </div>
            
            <h2 class="text-2xl font-black italic uppercase tracking-widest text-slate-800 leading-none mb-2">NASZEX</h2>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-8">Admin Access Only</p>

            <div class="space-y-4">
                <div class="float-input-group">
                    <input type="email" id="authEmail" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800 text-center" value="admin@naszex.com" placeholder=" ">
                    <label class="w-full text-center left-0">Admin Email</label>
                </div>
                <div class="float-input-group">
                    <input type="password" id="authPassword" onkeypress="if(event.key === 'Enter') handleLogin()" class="w-full neo-inset rounded-xl px-4 text-lg font-bold text-slate-800 text-center tracking-widest" placeholder=" ">
                    <label class="w-full text-center left-0">Access Key</label>
                </div>
                
                <button onclick="handleLogin()" id="btnLogin" class="w-full bg-slate-900 text-white py-4 mt-4 rounded-xl font-black uppercase text-[12px] tracking-widest shadow-xl shadow-slate-900/20 active:scale-95 transition-all flex items-center justify-center gap-2">
                    UNLOCK SYSTEM <i data-lucide="key" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <nav class="sticky top-0 z-40 px-5 py-4 pb-6 bg-gradient-to-b from-[#f1f5f9] to-transparent gpu pt-[max(1rem,env(safe-area-inset-top))]">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 neo-glass rounded-2xl flex items-center justify-center border border-white tap-effect">
                    <span class="gradient-text font-black text-sm italic">NX</span>
                </div>
                <div>
                    <h1 class="text-[15px] font-black italic uppercase tracking-widest text-slate-800 leading-none">NASZEX</h1>
                    <p class="text-[9px] font-bold text-indigo-500 uppercase tracking-[0.2em] mt-1.5 leading-none flex items-center gap-1">
                        <span id="cloud-status" class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></span>
                        CLOUD SYNC
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="fetchFromFirebase()" class="w-10 h-10 flex items-center justify-center neo-button rounded-xl text-slate-600 tap-effect" aria-label="Segarkan Data">
                    <i data-lucide="refresh-cw" id="refresh-icon" class="w-4 h-4"></i>
                </button>
                <button onclick="handleLogout()" class="w-10 h-10 flex items-center justify-center neo-button rounded-xl text-rose-500 tap-effect" aria-label="Log Keluar">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto relative pb-32 pt-2 px-5 -mt-2">
        
        <main id="dashboardView" class="view-section active space-y-5">
            <div class="mb-2">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Dashboard</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Today's Overview</p>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <div class="neo-glass border border-slate-200/60 rounded-[1.2rem] p-3 text-center tap-effect flex flex-col justify-center">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Active</p>
                    <p class="text-xl font-black text-slate-800 font-num leading-none" id="todayJobs">0</p>
                </div>
                <div class="neo-glass border border-rose-100/60 bg-rose-50/30 rounded-[1.2rem] p-3 text-center tap-effect flex flex-col justify-center">
                    <p class="text-[9px] font-black text-rose-400 uppercase tracking-widest mb-1">Pending</p>
                    <p class="text-xl font-black text-rose-600 font-num leading-none tracking-tight"><span class="text-[10px]">RM</span> <span id="stat-month-pending">0</span></p>
                </div>
                <div class="card-gradient-1 rounded-[1.2rem] p-3 text-center text-white tap-effect shadow-md relative overflow-hidden flex flex-col justify-center border border-emerald-400">
                    <div class="absolute -top-4 -right-4 w-12 h-12 bg-white/20 rounded-full blur-xl pointer-events-none"></div>
                    <p class="text-[9px] font-black text-emerald-100 uppercase tracking-widest mb-1 relative z-10">Paid</p>
                    <p class="text-xl font-black font-num leading-none tracking-tight relative z-10"><span class="text-[10px]">RM</span> <span id="stat-month-paid">0</span></p>
                </div>
            </div>

            <div class="space-y-4 mb-6 sticky top-[80px] z-30 pt-2 pb-4 bg-gradient-to-b from-[#f1f5f9] via-[#f1f5f9] to-transparent">
                <div class="relative group">
                    <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Search clients, phones, items..." 
                           class="w-full pl-12 pr-4 py-3.5 neo-inset rounded-2xl text-[12px] font-bold outline-none text-slate-700 placeholder:text-slate-400 font-num tracking-wide border border-slate-200/50">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 transition-colors group-focus-within:text-indigo-500"></i>
                </div>

                <div class="flex p-1.5 neo-glass rounded-2xl gap-1 border border-slate-200/60">
                    <button onclick="filterInvoices('outstanding')" id="f-pending" class="flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all tab-active tap-effect bg-slate-800 text-white shadow-md tracking-wider">Pending</button>
                    <button onclick="filterInvoices('paid')" id="f-paid" class="flex-1 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all text-slate-500 hover:text-slate-800 tap-effect tracking-wider">Paid</button>
                </div>
            </div>

            <div id="invoiceLoading" class="py-12 text-center list-anim hidden">
                <i data-lucide="loader-2" class="w-8 h-8 text-indigo-400 animate-spin mx-auto mb-3"></i>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Syncing Cloud...</p>
            </div>

            <div id="invoiceContainer" class="space-y-4 pb-12 min-h-[40vh]"></div>
        </main>

        <main id="reportsView" class="view-section space-y-5">
            <div class="mb-6">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Reports</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Analytics & Financials</p>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden mb-5">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center cursor-pointer tap-effect" onclick="toggleReportSection('itemProfitTable')">
                    <span class="text-[11px] font-black text-slate-700 uppercase tracking-widest"><i data-lucide="package" class="w-4 h-4 inline-block mr-1 text-indigo-500"></i> Item Profit List</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                </div>
                <div id="itemProfitTable" class="bg-white overflow-hidden transition-all duration-300">
                    <div class="max-h-72 overflow-y-auto no-scrollbar relative">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/90 backdrop-blur-md sticky top-0 z-10 shadow-sm border-b border-slate-200/50">
                                <tr>
                                    <th class="pl-5 py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Item / Kuantiti</th>
                                    <th class="text-center py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Kos (Modal)</th>
                                    <th class="text-right pr-5 py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Untung</th>
                                </tr>
                            </thead>
                            <tbody id="itemProfitBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden mb-5">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center cursor-pointer tap-effect" onclick="toggleReportSection('revenueTable')">
                    <span class="text-[11px] font-black text-slate-700 uppercase tracking-widest"><i data-lucide="bar-chart" class="w-4 h-4 inline-block mr-1 text-indigo-500"></i> Monthly Revenue</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                </div>
                <div id="revenueTable" class="bg-white overflow-hidden transition-all duration-300">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50/50">
                            <tr>
                                <th class="pl-5 py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Bulan</th>
                                <th class="text-center py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Job</th>
                                <th class="text-right pr-5 py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Jualan</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden mb-12">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center cursor-pointer tap-effect" onclick="toggleReportSection('profitTable')">
                    <span class="text-[11px] font-black text-slate-700 uppercase tracking-widest"><i data-lucide="pie-chart" class="w-4 h-4 inline-block mr-1 text-emerald-500"></i> Profit & Loss</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                </div>
                <div id="profitTable" class="bg-white overflow-hidden transition-all duration-300">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50/50">
                            <tr>
                                <th class="pl-5 py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Bulan</th>
                                <th class="text-center py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Modal (RM)</th>
                                <th class="text-right pr-5 py-3 text-[9px] font-bold uppercase text-slate-400 tracking-widest">Untung Bersih</th>
                            </tr>
                        </thead>
                        <tbody id="profitTableBody"></tbody>
                    </table>
                    <div class="p-4 bg-emerald-50/50 border-t border-emerald-100 flex justify-between items-center">
                        <span class="text-[10px] font-black text-emerald-700 uppercase tracking-widest">Total Untung Tahun Ini</span>
                        <span id="total-net-profit" class="text-lg font-black text-emerald-600">RM 0</span>
                    </div>
                </div>
            </div>
        </main>

        <main id="toolsView" class="view-section space-y-6">
            <div class="mb-6">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Tools</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Utilities & Settings</p>
            </div>
            
            <div class="relative group mb-6">
                <input type="text" id="toolsGlobalSearch" onkeyup="filterToolsSearch()" placeholder="Carian Global Tools..." 
                       class="w-full pl-12 pr-4 py-3.5 neo-inset rounded-2xl text-[12px] font-bold outline-none text-slate-700 placeholder:text-slate-400 tracking-wide border border-slate-200/50">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 transition-colors group-focus-within:text-indigo-500"></i>
            </div>
            
            <div class="bg-white rounded-[1.5rem] p-5 shadow-sm border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
                <h3 class="text-[11px] font-black text-slate-700 uppercase tracking-widest mb-4"><i data-lucide="smartphone" class="w-4 h-4 inline-block mr-1 text-indigo-500"></i> Quick Receipt</h3>
                <div class="flex gap-2 relative z-10">
                    <div class="float-input-group flex-1">
                        <input type="text" id="toolReceiptPhone" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800 font-num" placeholder=" ">
                        <label>No. Phone ATAU No. Invois</label>
                    </div>
                </div>
                <div class="flex gap-2 mt-3 relative z-10">
                    <button onclick="handleTools('whatsapp')" class="flex-1 py-3 bg-emerald-50 text-emerald-600 rounded-xl font-bold text-[10px] uppercase tracking-widest active:scale-95 transition-transform border border-emerald-100 flex items-center justify-center gap-1"><i data-lucide="message-circle" class="w-3.5 h-3.5"></i> WA</button>
                    <button onclick="handleTools('link')" class="flex-1 py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-[10px] uppercase tracking-widest active:scale-95 transition-transform border border-indigo-100 flex items-center justify-center gap-1"><i data-lucide="link" class="w-3.5 h-3.5"></i> Link</button>
                    <button onclick="handleTools('pdf')" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold text-[10px] uppercase tracking-widest active:scale-95 transition-transform shadow-md shadow-slate-900/20 flex items-center justify-center gap-1"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> PDF</button>
                </div>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-[11px] font-black text-slate-700 uppercase tracking-widest"><i data-lucide="briefcase" class="w-4 h-4 inline-block mr-1 text-indigo-500"></i> Service Catalog</span>
                    <button onclick="openServiceModal()" class="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center tap-effect border border-indigo-100"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div id="serviceCatalogList" class="max-h-64 overflow-y-auto no-scrollbar"></div>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden mb-6">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-[11px] font-black text-slate-700 uppercase tracking-widest"><i data-lucide="layers" class="w-4 h-4 inline-block mr-1 text-emerald-500"></i> Pricing Matrix</span>
                    <button onclick="openMatrixModal()" class="w-8 h-8 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center tap-effect border border-emerald-100"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <div class="p-4 border-b border-slate-50 bg-[#f8fafc]/30">
                    <div class="relative">
                        <input type="text" id="searchBrand" onkeyup="filterMatrix()" placeholder="Cari Jenama atau Model..." class="w-full neo-inset rounded-xl pl-10 pr-4 py-2.5 text-[11px] font-bold outline-none text-slate-700 placeholder:text-slate-400">
                        <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    </div>
                </div>
                <div id="matrixCatalogList" class="p-4 grid grid-cols-2 gap-3 max-h-64 overflow-y-auto no-scrollbar"></div>
            </div>
        </main>

        <main id="newjobView" class="view-section space-y-5">
            <div class="mb-6">
                <h2 id="pageTitle" class="text-2xl font-black text-slate-800 tracking-tight">Initiate Job</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Repair Form</p>
            </div>
            
            <input type="hidden" id="editId">
            
            <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100/50 space-y-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                <div class="float-input-group">
                    <input type="text" id="custName" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800" autocomplete="off" placeholder=" ">
                    <label>Nama Pelanggan</label>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="float-input-group">
                        <input type="tel" id="custPhone" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800 font-num" autocomplete="off" placeholder=" ">
                        <label>No. WhatsApp</label>
                    </div>
                    <div class="float-input-group">
                        <select id="warranty" class="w-full neo-inset rounded-xl px-4 text-xs font-bold text-slate-800">
                            <option value="Tiada Waranti">Tiada Waranti</option>
                            <option value="7 Hari">7 Hari</option>
                            <option value="30 Hari">30 Hari</option>
                            <option value="90 Hari">90 Hari</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div class="flex justify-between items-end px-2">
                    <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Services / Item</h4>
                    <button onclick="addRow()" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl uppercase tracking-wide transition-colors active:scale-95 flex items-center gap-1 border border-indigo-100 shadow-sm">
                        <i data-lucide="plus" class="w-3 h-3"></i> Tambah Item
                    </button>
                </div>
                <div id="itemRowsContainer" class="space-y-4"></div>
            </div>
            
            <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100/50 mt-4 space-y-5 relative">
                <div class="flex justify-between items-center relative z-10">
                    <div class="w-1/2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Status Invois</label>
                        <select id="initialStatus" class="neo-button text-slate-700 py-3 px-4 rounded-xl text-[11px] font-black uppercase outline-none w-full">
                            <option value="outstanding">‚è≥ Pending</option>
                            <option value="paid">‚úÖ Paid</option>
                        </select>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1 tracking-widest">Jumlah Keseluruhan</p>
                        <p class="text-3xl font-black text-slate-800 font-num leading-none">RM <span id="grandTotal">0.00</span></p>
                    </div>
                </div>
                <button onclick="saveAndGenerate()" id="btnSave" class="w-full bg-slate-900 text-white py-4 rounded-[1.2rem] font-black uppercase text-[12px] tracking-widest shadow-xl shadow-slate-900/20 active:scale-[0.98] transition-all flex items-center justify-center gap-2 relative z-10">
                    SAVE TO CLOUD <i data-lucide="cloud-upload" class="w-4 h-4"></i>
                </button>
            </div>
        </main>
    </div>

    <div class="floating-nav z-40 neo-glass flex justify-around items-center h-[70px] gpu border border-white/80 pb-[env(safe-area-inset-bottom)]">
        <button onclick="window.location.hash='dashboard'" id="nav-dash" class="flex flex-col items-center justify-center gap-1 w-16 text-indigo-600 transition-transform active:scale-90 nav-item-active pt-1">
            <i data-lucide="home" class="w-5 h-5 stroke-[2.5]"></i>
            <span class="text-[9px] font-black uppercase tracking-widest mt-1">Home</span>
        </button>
        <button onclick="window.location.hash='reports'" id="nav-reports" class="flex flex-col items-center justify-center gap-1 w-16 text-slate-400 hover:text-slate-600 transition-transform active:scale-90 pt-1">
            <i data-lucide="pie-chart" class="w-5 h-5 stroke-[2.5]"></i>
            <span class="text-[9px] font-black uppercase tracking-widest mt-1">Reports</span>
        </button>
        <button onclick="openNewJob()" id="nav-new" class="flex flex-col items-center justify-center gap-1 w-16 text-slate-400 hover:text-slate-600 transition-transform active:scale-90 pt-1">
            <i data-lucide="plus-square" class="w-5 h-5 stroke-[2.5]"></i>
            <span class="text-[9px] font-black uppercase tracking-widest mt-1">New Job</span>
        </button>
        <button onclick="window.location.hash='tools'" id="nav-tools-visible" class="flex flex-col items-center justify-center gap-1 w-16 text-slate-400 hover:text-slate-600 transition-transform active:scale-90 pt-1">
            <i data-lucide="wrench" class="w-5 h-5 stroke-[2.5]"></i>
            <span class="text-[9px] font-black uppercase tracking-widest mt-1">Tools</span>
        </button>
    </div>

    <div id="actionModal" class="fixed inset-x-0 bottom-0 z-[60] hidden modal-wrapper flex flex-col justify-end gpu">
        <div class="bg-white rounded-t-[2.5rem] w-full max-w-md mx-auto p-6 pb-[max(2rem,env(safe-area-inset-bottom))] shadow-[0_-20px_40px_rgba(0,0,0,0.1)] space-y-6">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto -mt-2 mb-2"></div>
            <div class="text-center">
                 <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Pengurusan Invois</p>
                 <h2 id="actionTargetName" class="font-black text-xl text-slate-800 truncate px-4 mt-1"></h2>
                 <p id="actionTargetNo" class="text-[11px] font-bold text-indigo-500 font-num mt-1 uppercase tracking-widest bg-indigo-50 inline-block px-3 py-1 rounded-full border border-indigo-100"></p>
            </div>
            <div class="bg-[#f1f5f9] p-4 rounded-2xl border border-slate-200/60 shadow-inner">
                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block text-center mb-3">Update Status Repair</label>
                <select id="updateRepairStatus" onchange="updateLiveStatusAndNotify(activeId, this.value)" class="w-full bg-white border border-slate-200 rounded-xl p-3.5 text-sm font-bold outline-none shadow-sm text-slate-700 text-center uppercase tracking-wider focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 transition-all">
                    <option value="Received">üì• 1. Received (Dalam Giliran)</option>
                    <option value="Diagnosing">üîç 2. Diagnosing (Check)</option>
                    <option value="Waiting Part">üì¶ 3. Waiting Part (Tunggu Alat Ganti)</option>
                    <option value="In Repair">‚öôÔ∏è 4. In Repair (Sedang Dibaiki)</option>
                    <option value="Testing">üì± 5. Testing Mode (Pengujian)</option>
                    <option value="Completed">‚úÖ 6. Completed</option>
                    <option value="Collected">ü§ù 7. Collected</option>
                    <option value="Cancelled">‚ùå 8. Cancelled</option>
                </select>
                <p class="text-[9px] text-center text-slate-400 font-medium mt-3">*Sistem akan sync status ke Firebase secara automatik.</p>
            </div>
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button id="btnToggleStatus" class="col-span-2 p-4 rounded-2xl font-black text-[12px] uppercase shadow-md active:scale-95 flex justify-between items-center px-6 transition-all duration-300"></button>
                <button onclick="handleAction('receipt')" class="p-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-slate-900/20 flex justify-center items-center gap-2 active:scale-95 transition-transform">
                    <i data-lucide="printer" class="w-4 h-4"></i> Print / Send
                </button>
                <button onclick="handleAction('edit')" class="p-4 neo-button text-slate-700 rounded-2xl font-black text-[10px] uppercase flex justify-center items-center gap-2 active:scale-95 transition-transform">
                    <i data-lucide="edit-3" class="w-4 h-4"></i> Edit
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="handleAction('delete')" class="flex-1 py-4 bg-rose-50 text-rose-600 rounded-xl font-bold text-[11px] uppercase tracking-widest active:scale-95 transition-transform border border-rose-100">Delete</button>
                <button onclick="closeActionMenu()" class="flex-1 py-4 bg-slate-100 text-slate-600 font-bold text-[11px] uppercase rounded-xl tracking-widest active:scale-95 transition-transform">Tutup</button>
            </div>
        </div>
    </div>

    <div id="serviceModal" class="fixed inset-x-0 bottom-0 z-[60] hidden modal-wrapper flex flex-col justify-end gpu">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[2.5rem] p-6 pb-[max(2rem,env(safe-area-inset-bottom))] shadow-[0_-20px_40px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[15px] font-black text-slate-800 uppercase tracking-tight">New Servis</h3>
                <button onclick="closeServiceModal()" class="w-10 h-10 bg-slate-50 border border-slate-100 rounded-full flex items-center justify-center text-slate-500 active:scale-90 transition-transform"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-5">
                <div class="float-input-group"><input type="text" id="svcName" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800" placeholder=" "><label>Jenis Servis</label></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="float-input-group"><select id="svcCategory" class="w-full neo-inset rounded-xl px-4 text-xs font-bold text-slate-800"><option value="Hardware">Hardware</option><option value="Software">Software</option><option value="Diagnostic">Diagnostik</option></select><label>Kategori</label></div>
                    <div class="float-input-group"><input type="number" id="svcLabor" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800 font-num" placeholder=" "><label>Caj (RM)</label></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="float-input-group"><select id="svcTime" class="w-full neo-inset rounded-xl px-4 text-xs font-bold text-slate-800"><option value="15-30 Minit">15-40 Minit</option><option value="1-2 Jam">1-2 Jam</option><option value="1-3 Hari">1-3 Hari</option><option value="Seminggu">3-7 Hari Bekerja</option></select><label>Masa</label></div>
                    <div class="float-input-group"><select id="svcWarranty" class="w-full neo-inset rounded-xl px-4 text-xs font-bold text-slate-800"><option value="Tiada">Tiada Waranti</option><option value="7 Hari">7 Hari</option><option value="30 Hari">30 Hari</option><option value="90 Hari">90 Hari</option></select><label>Warranty</label></div>
                </div>
                <button onclick="saveNewService()" id="btnSaveSvc" class="w-full bg-indigo-600 text-white font-black uppercase text-[12px] py-4 rounded-[1.2rem] flex items-center justify-center gap-2 active:scale-95 transition-transform tracking-widest mt-6">SAVE LOCAL</button>
            </div>
        </div>
    </div>

    <div id="matrixModal" class="fixed inset-x-0 bottom-0 z-[60] hidden modal-wrapper flex flex-col justify-end gpu">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[2.5rem] p-6 pb-[max(2rem,env(safe-area-inset-bottom))] shadow-[0_-20px_40px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[15px] font-black text-slate-800 uppercase tracking-tight">Add Matrix</h3>
                <button onclick="closeMatrixModal()" class="w-10 h-10 bg-slate-50 border border-slate-100 rounded-full flex items-center justify-center text-slate-500 active:scale-90 transition-transform"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="float-input-group"><input type="text" id="matBrand" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800" placeholder=" "><label>Jenama</label></div>
                    <div class="float-input-group"><input type="text" id="matModel" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800 font-num" placeholder=" "><label>Model</label></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="float-input-group">
                        <select id="matPartType" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800"><option value="LCD / Screen">LCD / Screen</option><option value="Battery">Battery</option><option value="Charging Port">Charging Port</option><option value="Motherboard">Motherboard</option><option value="Lain-lain">Lain-lain</option></select><label>Kategori</label>
                    </div>
                    <div class="float-input-group"><input type="text" id="matGrade" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800" placeholder=" "><label>Kualiti</label></div>
                </div>
                <div class="float-input-group"><input type="number" id="matPrice" class="w-full neo-inset rounded-xl px-4 text-sm font-bold text-slate-800 font-num" placeholder=" "><label>Harga (RM)</label></div>
                <button onclick="saveNewMatrix()" id="btnSaveMat" class="w-full bg-emerald-600 text-white font-black uppercase text-[12px] py-4 rounded-[1.2rem] flex items-center justify-center gap-2 active:scale-95 transition-transform tracking-widest mt-6">SAVE LOCAL</button>
            </div>
        </div>
    </div>

    <div id="brandDetailsModal" class="fixed inset-x-0 bottom-0 z-[60] hidden modal-wrapper flex flex-col justify-end gpu">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[2.5rem] p-6 pb-[max(2rem,env(safe-area-inset-bottom))] shadow-[0_-20px_40px_rgba(0,0,0,0.1)] h-[85dvh] flex flex-col">
            <div class="flex justify-between items-center mb-6 shrink-0 border-b border-slate-100 pb-4">
                <div><h3 id="brandDetailsTitle" class="text-[16px] font-black text-slate-800 uppercase tracking-tight">Brand</h3></div>
                <button onclick="closeBrandDetails()" class="w-10 h-10 bg-slate-50 border border-slate-100 rounded-full flex items-center justify-center text-slate-500 active:scale-90 transition-transform"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="brandDetailsList" class="overflow-y-auto space-y-3 flex-1 pb-4 no-scrollbar"></div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCSg9tH4E-71u8b3oFf5j9pDvhoNHZYnZg", 
            authDomain: "invoicely-52db9.firebaseapp.com", 
            projectId: "invoicely-52db9", 
            storageBucket: "invoicely-52db9.firebasestorage.app", 
            messagingSenderId: "512282448037", 
            appId: "1:512282448037:web:ad9600a2aa477c3533fd4c" 
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. GLOBAL STATES & UTILS ---
        let allInvoices = []; 
        let isFetching = false;
        let serviceCatalogData = getLS('nx_services', []);
        let globalMatrixData = getLS('nx_matrix', []);
        let businessProfile = getLS('nx_profile', {
            name: "NASZEX CLOUD", address: "Ara Kuda, Penang", ssm: "000000-X", phone: "01X-XXXXXXX"
        });
        let currentFilter = 'outstanding', activeId = null, searchTimeout = null;

        function getLS(key, def) { try { return JSON.parse(localStorage.getItem(key)) || def; } catch(e) { return def; } }
        function setLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

        // --- 3. INITIALIZATION & AUTHENTICATION ---
        document.addEventListener("DOMContentLoaded", () => { 
            lucide.createIcons(); 
            handleRouting();
            loadServiceCatalog();
            loadPricingMatrix();
            filterInvoices('outstanding');
        });

        // Listen for authentication state changes
        auth.onAuthStateChanged((user) => {
            const authScreen = document.getElementById('authScreen');
            if (user) {
                // Logged In: Fade out lock screen, fetch data
                authScreen.classList.add('opacity-0');
                setTimeout(() => {
                    authScreen.classList.add('hidden');
                    fetchFromFirebase(); 
                }, 700);
            } else {
                // Logged Out: Show lock screen immediately
                authScreen.classList.remove('hidden');
                // Small delay to ensure display block applies before opacity transition
                requestAnimationFrame(() => authScreen.classList.remove('opacity-0'));
            }
        });

        function handleLogin() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const btn = document.getElementById('btnLogin');

            if (!password) return showToast("Sila masukkan Access Key!", "error");

            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> VERIFYING...`;
            btn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    btn.innerHTML = `UNLOCK SYSTEM <i data-lucide="key" class="w-4 h-4"></i>`;
                    btn.disabled = false;
                    document.getElementById('authPassword').value = ''; 
                    showToast("System Unlocked!", "success");
                })
                .catch((error) => {
                    btn.innerHTML = `UNLOCK SYSTEM <i data-lucide="key" class="w-4 h-4"></i>`;
                    btn.disabled = false;
                    showToast("Access Key salah atau ralat server!", "error");
                    console.error("Auth Error:", error);
                });
        }

        function handleLogout() {
            if(confirm("Anda pasti mahu log keluar?")) {
                auth.signOut().then(() => {
                    allInvoices = []; 
                    document.getElementById('invoiceContainer').innerHTML = ''; 
                    document.getElementById('cloud-status').classList.remove('bg-emerald-500');
                    document.getElementById('cloud-status').classList.add('bg-amber-400');
                    showToast("Logged Out Berjaya", "success");
                }).catch((error) => {
                    showToast("Ralat Log Keluar", "error");
                    console.error(error);
                });
            }
        }

        // --- 4. FIREBASE CLOUD SYNC LOGIC ---
        async function fetchFromFirebase() {
            if (isFetching) return;
            isFetching = true;
            
            const btn = document.getElementById('refresh-icon');
            const loader = document.getElementById('invoiceLoading');
            const container = document.getElementById('invoiceContainer');
            
            if(btn) btn.classList.add('sync-spin');
            if(container && allInvoices.length === 0) {
                container.innerHTML = '';
                loader.classList.remove('hidden');
            }

            try {
                const snapshot = await db.collection("invoices").get();
                allInvoices = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const timestamp = data.createdAt && data.createdAt.seconds 
                        ? data.createdAt.seconds * 1000 
                        : data.createdAt;
                    return { id: doc.id, ...data, createdAt: timestamp };
                });
                
                allInvoices.sort((a, b) => b.createdAt - a.createdAt);
                
                updateDashboard();
                generateItemProfitReport();
                generateReport();
                generateProfitReport();
                
                document.getElementById('cloud-status').classList.remove('bg-amber-400', 'bg-rose-500');
                document.getElementById('cloud-status').classList.add('bg-emerald-500');
            } catch (error) {
                console.error("Firebase Sync Error:", error);
                showToast("Gagal sync awan. Periksa internet anda.", "error");
                document.getElementById('cloud-status').classList.remove('bg-emerald-500', 'bg-amber-400');
                document.getElementById('cloud-status').classList.add('bg-rose-500');
            } finally {
                isFetching = false;
                if(btn) btn.classList.remove('sync-spin');
                if(loader) loader.classList.add('hidden');
                
                // Show empty state if really empty after fetching
                if(allInvoices.length === 0 && container) {
                    updateDashboard(); 
                }
            }
        }

        async function saveAndGenerate() {
            const n = document.getElementById('custName').value.trim(), p = document.getElementById('custPhone').value.trim();
            if(!n || !p) return showToast("Sila isi Nama & No. WA!", "error");
            
            const btn = document.getElementById('btnSave');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> SYNCING...`;
            btn.disabled = true;

            const items = [];
            document.querySelectorAll('.item-entry').forEach(r => {
                const name = r.querySelector('.item-name').value;
                if(name) items.push({
                    name: name,
                    description: r.querySelector('.item-desc').value.trim(),
                    qty: parseFloat(r.querySelector('.qty').value)||1, kos: parseFloat(r.querySelector('.kos').value)||0,
                    modal: parseFloat(r.querySelector('.modal-price').value)||0, discount: parseFloat(r.querySelector('.discount').value)||0
                });
            });

            if(items.length === 0) {
                btn.innerHTML = `SAVE TO CLOUD <i data-lucide="cloud-upload" class="w-4 h-4"></i>`;
                btn.disabled = false;
                return showToast("Sila masukkan sekurang-kurangnya 1 item!", "error");
            }

            const editId = document.getElementById('editId').value;
            const newId = editId || Date.now().toString(); 

            const dataToSave = {
                id: newId, 
                customerName: n, 
                customerPhone: p, 
                warranty: document.getElementById('warranty').value,
                status: document.getElementById('initialStatus').value, 
                total: document.getElementById('grandTotal').innerText, 
                items: items,
                repairStatus: 'Received',
                createdAt: Date.now()
            };
            
            try {
                if(editId) {
                    const idx = allInvoices.findIndex(x => x.id === editId);
                    if(idx !== -1) {
                        dataToSave.invoiceNo = allInvoices[idx].invoiceNo;
                        dataToSave.createdAt = allInvoices[idx].createdAt; 
                        dataToSave.repairStatus = allInvoices[idx].repairStatus;
                    }
                    await db.collection("invoices").doc(newId).set(dataToSave);
                    showToast("Invois dikemaskini di Awan!");
                } else {
                    const prefix = 'INV-';
                    const lastNo = allInvoices.reduce((max, i) => {
                        let num = 0;
                        if(i.invoiceNo && i.invoiceNo.includes('-')) num = parseInt(i.invoiceNo.split('-')[1]);
                        return Math.max(max, isNaN(num) ? 0 : num);
                    }, 0);
                    dataToSave.invoiceNo = prefix + (lastNo + 1).toString().padStart(4, '0');
                    
                    await db.collection("invoices").doc(newId).set(dataToSave);
                    showToast("Job berjaya dicipta di Awan!");
                    
                    if(confirm("Buka WhatsApp untuk hantar link resit live?")) {
                        const link = `${window.location.origin}/view.html?id=${newId}`;
                        const msg = `Salam ${n}, terima kasih berurusan dengan kami.\nPeranti anda telah didaftarkan:\nüîñ *No. Rujukan:* ${dataToSave.invoiceNo}\n\nSila klik link di bawah untuk pantau status repair secara 'Live':\n${link}`;
                        window.open(`https://wa.me/60${p.replace(/^0+/,'')}?text=${encodeURIComponent(msg)}`, '_blank');
                    }
                }
                
                await fetchFromFirebase();
                window.location.hash = 'dashboard';
            } catch (error) {
                console.error(error);
                showToast("Ralat menyimpan ke Awan!", "error");
            } finally {
                btn.innerHTML = `SAVE TO CLOUD <i data-lucide="cloud-upload" class="w-4 h-4"></i>`;
                btn.disabled = false;
            }
        }

        async function updateLiveStatusAndNotify(id, newStatus) {
            try {
                await db.collection("invoices").doc(id).update({ repairStatus: newStatus });
                await fetchFromFirebase();
                
                if(confirm(`Status dikemaskini ke: ${newStatus} di Awan.\nBuka WhatsApp untuk maklumkan pelanggan?`)) {
                    sendWhatsApp(null, id); 
                }
                closeActionMenu();
            } catch (err) {
                console.error(err);
                showToast("Gagal update status di Awan", "error");
            }
        }

        // --- 5. UI & ROUTING ---
        function handleRouting() {
            let hash = window.location.hash.replace('#', '');
            if (!hash) hash = 'dashboard';
            if (['dashboard', 'reports', 'tools', 'newjob'].includes(hash)) { showPage(hash); }
        }
        window.addEventListener('hashchange', handleRouting);

        function showPage(p) {
            const views = ['dashboardView', 'reportsView', 'toolsView', 'newjobView'];
            const target = document.getElementById(p + 'View');
            if (!target || target.classList.contains('active')) return;
            views.forEach(v => { const el = document.getElementById(v); if (el) el.classList.remove('active'); });
            target.classList.add('active'); window.scrollTo({top: 0, behavior: 'instant'});
            document.querySelectorAll('button[id^="nav-"]').forEach(b => { b.classList.remove('nav-item-active', 'text-indigo-600'); b.classList.add('text-slate-400'); });
            let activeId = 'nav-' + (p === 'dashboard' ? 'dash' : p); if(p === 'tools') activeId = 'nav-tools-visible';
            const activeBtn = document.getElementById(activeId);
            if(activeBtn) { activeBtn.classList.add('nav-item-active', 'text-indigo-600'); activeBtn.classList.remove('text-slate-400'); }
        }

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : 'alert-circle'; const color = type === 'success' ? 'text-emerald-500' : 'text-rose-500';
            toast.className = 'toast'; toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 ${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast); lucide.createIcons();
            if(navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => { toast.classList.add('out'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function filterInvoices(type) {
            currentFilter = type;
            const ids = {paid: 'f-paid', outstanding: 'f-pending'};
            Object.keys(ids).forEach(k => {
                const el = document.getElementById(ids[k]);
                if(el) {
                    if(k === type) { el.classList.add('tab-active', 'bg-slate-800', 'text-white', 'shadow-md'); el.classList.remove('text-slate-500', 'hover:text-slate-800', 'bg-transparent'); } 
                    else { el.classList.remove('tab-active', 'bg-slate-800', 'text-white', 'shadow-md'); el.classList.add('text-slate-500', 'hover:text-slate-800'); }
                }
            });
            updateDashboard();
        }

        function handleSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { updateDashboard(document.getElementById('searchInput').value); }, 300); }
        function toggleReportSection(id) { const el = document.getElementById(id); if(el.classList.contains('hidden')) el.classList.remove('hidden'); else el.classList.add('hidden'); }

        function copyToClipboard(text) {
            if(navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(() => showToast("Link disalin!", "success"));
            } else { let textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-999999px"; textArea.style.top = "-999999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); showToast("Link disalin!", "success"); } catch (err) { showToast("Gagal menyalin link", "error"); } textArea.remove(); }
        }

        function shareInvoiceLink(event, id, invoiceNo) {
            event.stopPropagation(); const link = `${window.location.origin}/view.html?id=${id}`;
            if (navigator.share) { try { navigator.share({ title: `Invois ${invoiceNo}`, text: `Sila klik pautan ini untuk melihat butiran invois / resit anda secara Live.`, url: link }); } catch (err) { copyToClipboard(link); }
            } else { copyToClipboard(link); }
        }

        function sendWhatsApp(event, id) {
            if(event) event.stopPropagation();
            const i = allInvoices.find(x => x.id === id); if(!i) return;
            const link = `${window.location.origin}/view.html?id=${id}`;
            const msg = `*STATUS KEMASKINI*\n\nSalam ${i.customerName},\nBerikut adalah status terkini peranti anda di ${businessProfile.name}:\n\nüîñ *No. Rujukan:* ${i.invoiceNo}\nüîß *Status:* ${i.repairStatus || 'Received'}\nüíµ *Jumlah Bil:* RM ${i.total}\n\nTrack secara Live di sini: ${link}`;
            window.open(`https://wa.me/60${i.customerPhone.replace(/^0+/,'')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function updateDashboard(search = "") {
            const container = document.getElementById('invoiceContainer'); if(!container) return;
            const now = new Date(); let mPaid=0, mPending=0, todayJ=0;

            allInvoices.forEach(i => {
                const d = new Date(i.createdAt);
                if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) { if(i.status === 'paid') mPaid += parseFloat(i.total); else mPending += parseFloat(i.total); }
                if(d.getDate() === now.getDate() && d.getMonth() === now.getMonth()) todayJ++;
            });

            document.getElementById('stat-month-paid').innerText = Math.round(mPaid); document.getElementById('stat-month-pending').innerText = Math.round(mPending); document.getElementById('todayJobs').innerText = todayJ;

            let filtered = allInvoices.filter(i => {
                if(i.status !== currentFilter) return false;
                if(search) { const q = search.toLowerCase(); const itemName = i.items && i.items[0] ? i.items[0].name.toLowerCase() : ""; return (i.customerName||"").toLowerCase().includes(q) || (i.customerPhone||"").includes(q) || itemName.includes(q); }
                return true;
            });

            if(filtered.length === 0 && !isFetching) {
                 container.innerHTML = `
                    <div class="py-16 text-center list-anim">
                        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-indigo-100"><i data-lucide="folder-search" class="w-10 h-10 text-indigo-300"></i></div>
                        <h3 class="text-sm font-black text-slate-700 uppercase tracking-widest mb-1">Tiada Rekod Dijumpai</h3>
                        <p class="text-[11px] font-medium text-slate-400">Semua tugas di bahagian ini telah selesai!</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            if (!isFetching) {
                container.innerHTML = '';
                filtered.forEach((i, index) => {
                    const isPaid = i.status === 'paid';
                    const statusBadge = isPaid ? `<span class="text-[9px] font-black uppercase px-2.5 py-1 rounded-lg bg-emerald-50 text-emerald-600 border border-emerald-100/50">PAID</span>` : `<span class="text-[9px] font-black uppercase px-2.5 py-1 rounded-lg bg-rose-50 text-rose-500 border border-rose-100/50">PENDING</span>`;
                    const pColor = { 'Received': 'bg-slate-100 text-slate-600', 'Diagnosing': 'bg-purple-100 text-purple-600', 'Waiting Part': 'bg-amber-100 text-amber-600', 'In Repair': 'bg-blue-100 text-blue-600', 'Testing': 'bg-indigo-100 text-indigo-600', 'Completed': 'bg-emerald-500 text-white shadow-md shadow-emerald-500/40', 'Collected': 'bg-slate-900 text-white shadow-md shadow-slate-900/40', 'Cancelled': 'bg-rose-100 text-rose-600' };
                    const badgeColor = pColor[i.repairStatus] || 'bg-slate-100 text-slate-600';
                    
                    let deviceDesc = "Servis Umum"; if(i.items && i.items.length > 0) deviceDesc = i.items[0].name.substring(0,30);
                    const d = new Date(i.createdAt); const dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
                    
                    container.insertAdjacentHTML('beforeend', `
                    <div onclick="openActionMenu('${i.id}')" class="list-anim ios-glass p-4 rounded-[1.5rem] cursor-pointer group relative overflow-hidden mb-4">
                        <div class="absolute top-4 right-4 flex gap-2 z-10">
                            <button onclick="sendWhatsApp(event, '${i.id}')" class="w-8 h-8 bg-emerald-50 border border-emerald-100 shadow-sm text-emerald-500 hover:text-emerald-600 rounded-full flex items-center justify-center transition-colors"><i data-lucide="message-circle" class="w-3.5 h-3.5"></i></button>
                            <button onclick="shareInvoiceLink(event, '${i.id}', '${i.invoiceNo}')" class="w-8 h-8 bg-slate-50 border border-slate-100 shadow-sm text-slate-400 hover:text-indigo-500 rounded-full flex items-center justify-center transition-colors"><i data-lucide="link" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl ${badgeColor} flex items-center justify-center shrink-0 border border-white/50"><i data-lucide="tool" class="w-5 h-5"></i></div>
                            <div class="flex-1 pr-20 min-w-0">
                                <h4 class="text-[13px] font-black text-slate-800 leading-tight truncate">${i.customerName}</h4>
                                <p class="text-[11px] font-medium text-slate-500 mt-1 truncate">${deviceDesc}</p>
                                <p class="text-[9px] font-bold text-indigo-400 mt-1.5 uppercase tracking-widest">${dateStr} ‚Ä¢ ${(i.repairStatus||'NEW').substring(0,10)}</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-end mt-4 pt-3 border-t border-slate-200/50">
                            ${statusBadge}
                            <p class="text-[15px] font-black text-slate-800 font-num tracking-tight">RM ${Math.round(i.total)}</p>
                        </div>
                    </div>`);
                });
                lucide.createIcons();
            }
        }

        // --- 6. FORM LOGIC ---
        function openNewJob() {
            document.getElementById('pageTitle').innerText = "Initiate Job";
            document.getElementById('editId').value = "";
            document.getElementById('custName').value = ""; document.getElementById('custPhone').value = "";
            document.getElementById('itemRowsContainer').innerHTML = ""; addRow();
            document.getElementById('grandTotal').innerText = "0.00"; document.getElementById('initialStatus').value = "outstanding";
            window.location.hash = 'newjob';
        }

        function createItemRow(d = {}) {
            return `
            <div class="item-entry neo-inset p-4 rounded-[1.2rem] relative mb-4 list-anim border border-transparent hover:border-indigo-100 transition-colors">
                <button onclick="this.closest('.item-entry').remove(); calculateTotal();" class="absolute -top-3 -right-3 bg-white text-rose-500 rounded-full w-8 h-8 shadow-lg flex items-center justify-center hover:bg-rose-50 transition-colors z-10 border border-slate-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                <div class="space-y-3 mb-3">
                    <input type="text" class="item-name w-full bg-white border border-slate-200 rounded-xl p-3 text-sm font-bold outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 placeholder:text-slate-300 transition-shadow" placeholder="Item / Part" value="${d.name || ''}">
                    <textarea class="item-desc w-full bg-white border border-slate-200 rounded-xl p-3 text-xs font-medium outline-none focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 resize-none h-14 placeholder:text-slate-300 transition-shadow" placeholder="Optional description...">${d.description || ''}</textarea>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div class="float-input-group"><input type="number" oninput="calculateTotal()" class="qty w-full bg-white border border-slate-200 rounded-lg px-1 text-center font-bold text-[12px] font-num focus:border-indigo-400" value="${d.qty || 1}"><label class="w-full text-center">Qty</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" oninput="calculateTotal()" class="kos w-full bg-white border border-slate-200 rounded-lg px-1 text-center font-bold text-[12px] font-num focus:border-indigo-400" value="${d.kos || ''}"><label class="w-full text-center text-slate-500">Harga</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" class="modal-price w-full bg-white border border-rose-100 rounded-lg px-1 text-center font-bold text-[12px] text-rose-500 font-num" value="${d.modal || ''}"><label class="w-full text-center text-rose-400">Modal</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" oninput="calculateTotal()" class="discount w-full bg-white border border-blue-100 rounded-lg px-1 text-center font-bold text-[12px] text-blue-500 font-num" value="${d.discount || ''}"><label class="w-full text-center text-blue-400">Disc</label></div>
                </div>
            </div>`;
        }
        function addRow() { const c = document.getElementById('itemRowsContainer'); if(c) { c.insertAdjacentHTML('beforeend', createItemRow()); lucide.createIcons(); setTimeout(() => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 100); } }
        function calculateTotal() { let t = 0; document.querySelectorAll('.item-entry').forEach(r => { const q = parseFloat(r.querySelector('.qty').value)||0, k = parseFloat(r.querySelector('.kos').value)||0, d = parseFloat(r.querySelector('.discount').value)||0; t += (q * k) - d; }); document.getElementById('grandTotal').innerText = t.toFixed(2); }

        // --- 7. ACTION MODAL ---
        function toggleModal(show, backdropOnly = false) { const bg = document.getElementById('modalBackdrop'); if(show) { bg.classList.remove('hidden'); bg.classList.add('active'); } else { bg.classList.remove('active'); setTimeout(() => bg.classList.add('hidden'), 400); } }
        function openActionMenu(id) {
            activeId = id; const i = allInvoices.find(x=>x.id===id); if (!i) return;
            document.getElementById('actionTargetName').innerText = i.customerName; document.getElementById('actionTargetNo').innerText = "Rujukan: " + i.invoiceNo;
            document.getElementById('updateRepairStatus').value = i.repairStatus || 'Received';
            const btn = document.getElementById('btnToggleStatus'); btn.onclick = null;
            if (i.status === 'paid') {
                btn.className = "col-span-2 p-4 bg-white text-slate-700 border border-slate-200 rounded-2xl font-black text-[11px] uppercase shadow-sm active:scale-95 flex justify-between items-center px-6 transition-all";
                btn.innerHTML = `<span>Revert to Pending</span><i data-lucide="rotate-ccw" class="w-4 h-4 text-slate-400"></i>`;
                btn.onclick = async () => { try { await db.collection("invoices").doc(id).update({status: 'outstanding'}); await fetchFromFirebase(); showToast("Status Ditukar: PENDING"); closeActionMenu(); } catch(e) { showToast("Gagal kemaskini Awan", "error"); } };
            } else {
                btn.className = "col-span-2 p-4 bg-emerald-500 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg shadow-emerald-500/30 active:scale-95 flex justify-between items-center px-6 transition-all";
                btn.innerHTML = `<span>Mark As Paid</span><i data-lucide="check-circle" class="w-4 h-4 text-white"></i>`;
                btn.onclick = async () => { try { await db.collection("invoices").doc(id).update({status: 'paid'}); await fetchFromFirebase(); showToast("Bayaran Disahkan!"); closeActionMenu(); } catch(e) { showToast("Gagal kemaskini Awan", "error"); } };
            }
            toggleModal(true, true); const m = document.getElementById('actionModal'); m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('active')); lucide.createIcons();
        }
        function closeActionMenu() { toggleModal(false, true); const m = document.getElementById('actionModal'); m.classList.remove('active'); setTimeout(()=>m.classList.add('hidden'), 400); }
        
        async function handleAction(type) {
            if(type === 'edit') {
                const i = allInvoices.find(x=>x.id===activeId); if(!i) return;
                document.getElementById('editId').value = activeId; document.getElementById('pageTitle').innerText = "Edit Job";
                document.getElementById('custName').value = i.customerName; document.getElementById('custPhone').value = i.customerPhone;
                document.getElementById('warranty').value = i.warranty || 'Tiada Waranti'; document.getElementById('initialStatus').value = i.status;
                const cont = document.getElementById('itemRowsContainer'); cont.innerHTML = "";
                (i.items||[]).forEach(it => { cont.insertAdjacentHTML('beforeend', createItemRow(it)); });
                calculateTotal(); closeActionMenu(); window.location.hash = 'newjob';
            }
            if(type === 'delete' && confirm("Anda pasti mahu hapus rekod ini secara kekal dari Cloud?")) { 
                try { await db.collection("invoices").doc(activeId).delete(); await fetchFromFirebase(); showToast("Rekod Dihapus dari Awan"); closeActionMenu(); } 
                catch(e) { showToast("Gagal memadam dari Awan", "error"); }
            }
            if(type === 'receipt') { generateInvoicePDF(allInvoices.find(x=>x.id===activeId)); closeActionMenu(); }
        }

        // --- 8. PDF GENERATOR ---
        function generateInvoicePDF(inv) { if(!inv) return; const { jsPDF } = window.jspdf; const doc = new jsPDF(); const pageWidth = doc.internal.pageSize.width; doc.setFillColor(15, 23, 42); doc.rect(0, 0, pageWidth, 45, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.setFont("helvetica", "bold"); doc.text(businessProfile.name || "NASZEX CLOUD", 15, 20); doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("Professional Device Repair Center", 15, 26); doc.setFontSize(9); const addr = businessProfile.address || "Ara Kuda, Penang"; const splittedAddr = doc.splitTextToSize(addr, 70); doc.text(splittedAddr, pageWidth - 15, 18, { align: "right" }); doc.text(`SSM: ${businessProfile.ssm || '-'}`, pageWidth - 15, 30, { align: "right" }); doc.text(`Tel/WA: ${businessProfile.phone || '-'}`, pageWidth - 15, 35, { align: "right" }); doc.setTextColor(30, 41, 59); doc.setFontSize(18); doc.setFont("helvetica", "bold"); const docType = inv.status === 'paid' ? "OFFICIAL RECEIPT" : "INVOICE"; doc.text(docType, 15, 60); doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text(`No. Rujukan: ${inv.invoiceNo}`, 15, 68); const d = new Date(inv.createdAt); doc.text(`Tarikh: ${d.toLocaleDateString('ms-MY')}`, 15, 74); doc.text(`Status: ${inv.status.toUpperCase()}`, 15, 80); doc.setFont("helvetica", "bold"); doc.text("KEPADA:", 120, 68); doc.setFont("helvetica", "normal"); doc.text(inv.customerName, 120, 74); doc.text(`Telefon: ${inv.customerPhone}`, 120, 80); const rows = (inv.items||[]).map(x => [ x.name + (x.description ? `\n( ${x.description} )` : ''), x.qty, `RM ${parseFloat(x.kos).toFixed(2)}`, `RM ${parseFloat(x.discount).toFixed(2)}`, `RM ${((x.qty*x.kos)-x.discount).toFixed(2)}` ]); doc.autoTable({ startY: 95, head: [['Perkara / Kerosakan', 'Unit', 'Harga (RM)', 'Diskaun', 'Jumlah (RM)']], body: rows, theme: 'grid', headStyles: { fillColor: [15, 23, 42], textColor: 255, fontStyle: 'bold' }, styles: { fontSize: 9 } }); let finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(14); doc.setFont("helvetica", "bold"); doc.text(`JUMLAH: RM ${parseFloat(inv.total).toFixed(2)}`, 130, finalY); doc.setFontSize(9); doc.setTextColor(100); doc.setFont("helvetica", "normal"); doc.text(`Waranti: ${inv.warranty || 'Tiada'}`, 15, finalY); doc.setFontSize(8); doc.setTextColor(150); let termY = 260; doc.text("TERMA & SYARAT:", 15, termY); termY += 5; const customNotes = [ "1. Waranti hanya meliputi kerosakan pada komponen yang ditukar sahaja.", "2. Pihak kami tidak bertanggungjawab atas kehilangan data pengguna.", "3. Peranti yang tidak dituntut selepas 90 hari akan dilupuskan." ]; doc.text(customNotes, 15, termY); doc.save(`${inv.invoiceNo}-${inv.customerName}.pdf`); showToast("Dokumen PDF Berjaya Dijana"); }

        // --- 9. REPORTS & TOOLS ---
        function filterToolsSearch() { const input = document.getElementById('toolsGlobalSearch').value.toLowerCase(); document.querySelectorAll('#serviceCatalogList .service-item').forEach(item => { const text = item.innerText.toLowerCase(); item.style.display = text.includes(input) ? 'flex' : 'none'; }); document.getElementById('searchBrand').value = input; filterMatrix(); }
        function handleTools(act) { const p = document.getElementById('toolReceiptPhone').value.trim().toLowerCase(); if(!p) return showToast("Sila masukkan No. Phone atau Invois", "error"); const match = allInvoices.filter(i => i.customerPhone.toLowerCase().includes(p) || i.invoiceNo.toLowerCase().includes(p)).sort((a,b) => b.createdAt - a.createdAt)[0]; if(!match) return showToast("Tiada rekod dijumpai", "error"); if(act === 'whatsapp') { sendWhatsApp(null, match.id); } else if (act === 'link') { const link = `${window.location.origin}/view.html?id=${match.id}`; copyToClipboard(link); } else { generateInvoicePDF(match); } }
        
        function generateItemProfitReport() { const tb = document.getElementById('itemProfitBody'); if(!tb) return; let itemStats = {}; allInvoices.forEach(inv => { if(inv.status === 'paid') { (inv.items || []).forEach(it => { let name = it.name.trim().toUpperCase(); if(!name) name = "UMUM / LAIN-LAIN"; let qty = parseFloat(it.qty) || 1; let sellingPrice = parseFloat(it.kos) || 0; let costPrice = parseFloat(it.modal) || 0; let discount = parseFloat(it.discount) || 0; let itemCost = qty * costPrice; let itemRevenue = (qty * sellingPrice) - discount; let itemProfit = itemRevenue - itemCost; if(!itemStats[name]) { itemStats[name] = { qty: 0, cost: 0, profit: 0 }; } itemStats[name].qty += qty; itemStats[name].cost += itemCost; itemStats[name].profit += itemProfit; }); } }); let sortedItems = Object.keys(itemStats).map(k => ({ name: k, ...itemStats[k] })).sort((a, b) => b.profit - a.profit); let h = ""; if (sortedItems.length === 0) { h = '<tr><td colspan="3" class="text-center py-8 text-xs font-bold text-slate-400">Tiada Data Jualan</td></tr>'; } else { sortedItems.forEach(item => { h += `<tr class="border-b border-slate-100/50 last:border-0 hover:bg-slate-50 transition-colors"><td class="pl-5 py-3"><p class="text-[10px] font-black text-slate-700 leading-tight">${item.name}</p><p class="text-[8px] font-bold text-slate-400 mt-0.5 uppercase tracking-wider">${item.qty} Terjual</p></td><td class="text-center py-3 text-[10px] font-bold text-rose-500 font-num">RM ${item.cost.toFixed(2)}</td><td class="text-right pr-5 py-3 text-[11px] font-black text-emerald-600 font-num">RM ${item.profit.toFixed(2)}</td></tr>`; }); } tb.innerHTML = h; }
        function generateReport() { const tb = document.getElementById('reportTableBody'); if(!tb) return; const mo = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"]; let h = ""; const currentYear = new Date().getFullYear(); mo.forEach((m, i) => { const monthly = allInvoices.filter(inv => { const d = new Date(inv.createdAt); return d.getMonth() === i && d.getFullYear() === currentYear; }); const pS = monthly.reduce((s, inv) => inv.status === 'paid' ? s + parseFloat(inv.total) : s, 0); if (monthly.length > 0) h += `<tr class="border-b border-slate-200/50 last:border-0"><td class="pl-5 py-4 text-slate-600 uppercase font-black text-[10px]">${m}</td><td class="text-center text-slate-500 font-bold">${monthly.length}</td><td class="text-right pr-5 text-slate-800 font-black">RM ${Math.round(pS)}</td></tr>`; }); tb.innerHTML = h || '<tr><td colspan="3" class="text-center py-8 text-xs font-bold text-slate-400">Tiada Data</td></tr>'; }
        function generateProfitReport() { const tb = document.getElementById('profitTableBody'); if(!tb) return; const mo = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"]; let h = "", totalNett = 0; const currentYear = new Date().getFullYear(); mo.forEach((m, i) => { const monthly = allInvoices.filter(inv => { const d = new Date(inv.createdAt); return d.getMonth() === i && d.getFullYear() === currentYear && inv.status === 'paid'; }); let mModal = 0, mRev = 0; monthly.forEach(inv => { mRev += parseFloat(inv.total); (inv.items || []).forEach(it => { mModal += (parseFloat(it.modal)||0) * (parseFloat(it.qty)||1); }); }); const mProfit = mRev - mModal; totalNett += mProfit; if(mRev > 0) h += `<tr class="border-b border-slate-200/50 last:border-0"><td class="pl-5 py-4 text-slate-600 uppercase font-black text-[10px]">${m}</td><td class="text-center text-rose-500 font-bold">RM ${Math.round(mModal)}</td><td class="text-right pr-5 text-emerald-600 font-black">RM ${Math.round(mProfit)}</td></tr>`; }); tb.innerHTML = h || '<tr><td colspan="3" class="text-center py-8 text-xs font-bold text-slate-400">Tiada Data</td></tr>'; const totalEl = document.getElementById('total-net-profit'); if(totalEl) totalEl.innerText = `RM ${Math.round(totalNett)}`; }

        // --- 10. CATALOGS & MATRICES ---
        function loadServiceCatalog() { const listContainer = document.getElementById('serviceCatalogList'); if(!listContainer) return; if (serviceCatalogData.length === 0) { listContainer.innerHTML = `<div class="p-6 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Tiada Servis Didaftarkan</div>`; return; } let html = ''; serviceCatalogData.forEach(s => { html += `<div class="service-item px-5 py-4 flex justify-between items-center group hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0 bg-[#f8fafc]/30"><div><h4 class="text-[12px] font-black text-slate-800 uppercase">${s.name}</h4><p class="text-[9px] font-bold text-slate-500 mt-0.5">${s.category} ‚Ä¢ ${s.estTime}</p></div><div class="text-right"><p class="text-[12px] font-black text-slate-800 font-num">RM ${parseFloat(s.laborBase).toFixed(2)}</p><button onclick="deleteService('${s.id}')" class="text-[8px] text-rose-400 hover:text-rose-600 font-bold uppercase tracking-widest mt-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">Padam</button></div></div>`; }); listContainer.innerHTML = html; }
        function openServiceModal() { toggleModal(true, true); const m = document.getElementById('serviceModal'); m.classList.remove('hidden'); requestAnimationFrame(() => m.classList.add('active')); }
        function closeServiceModal() { toggleModal(false, true); const m = document.getElementById('serviceModal'); m.classList.remove('active'); setTimeout(() => m.classList.add('hidden'), 400); document.getElementById('svcName').value = ''; document.getElementById('svcLabor').value = ''; }
        function saveNewService() { const name = document.getElementById('svcName').value.trim(), category = document.getElementById('svcCategory').value; const laborBase = document.getElementById('svcLabor').value.trim(), estTime = document.getElementById('svcTime').value, warranty = document.getElementById('svcWarranty').value; if (!name || !laborBase) return showToast("Sila isi Nama Servis dan Caj!", "error"); serviceCatalogData.unshift({ id: Date.now().toString(), name, category, laborBase: parseFloat(laborBase), estTime, warranty, createdAt: Date.now() }); setLS('nx_services', serviceCatalogData); showToast("Servis ditambah!"); closeServiceModal(); loadServiceCatalog(); }
        function deleteService(id) { if(confirm("Padam servis ini dari katalog?")) { serviceCatalogData = serviceCatalogData.filter(x => x.id !== id); setLS('nx_services', serviceCatalogData); showToast("Servis dipadam."); loadServiceCatalog(); } }

        function openMatrixModal() { toggleModal(true, true); const m = document.getElementById('matrixModal'); m.classList.remove('hidden'); requestAnimationFrame(() => m.classList.add('active')); }
        function closeMatrixModal() { toggleModal(false, true); const m = document.getElementById('matrixModal'); m.classList.remove('active'); setTimeout(() => m.classList.add('hidden'), 400); document.getElementById('matBrand').value = ''; document.getElementById('matModel').value = ''; document.getElementById('matGrade').value = ''; document.getElementById('matPrice').value = ''; }
        function loadPricingMatrix() { const listContainer = document.getElementById('matrixCatalogList'); if(!listContainer) return; if (globalMatrixData.length === 0) { listContainer.innerHTML = `<div class="col-span-2 p-6 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Tiada Matriks</div>`; return; } const brandsMap = {}; globalMatrixData.forEach(m => { const brandName = m.brand.toUpperCase(); if(!brandsMap[brandName]) brandsMap[brandName] = []; brandsMap[brandName].push(m); }); listContainer.innerHTML = ''; for (let brand in brandsMap) { const count = brandsMap[brand].length; listContainer.innerHTML += `<div data-brand="${brand}" onclick="openBrandDetails('${brand}')" class="brand-card neo-button rounded-[1.2rem] p-4 flex flex-col items-center justify-center gap-2 tap-effect"><div class="w-12 h-12 bg-emerald-50 text-emerald-500 rounded-xl flex items-center justify-center border border-emerald-100"><i data-lucide="smartphone" class="w-6 h-6"></i></div><h4 class="text-[13px] font-black text-slate-800 text-center uppercase leading-tight mt-1">${brand}</h4><span class="text-[9px] font-bold text-slate-500 bg-slate-100 px-2.5 py-0.5 rounded-md">${count} Model</span></div>`; } lucide.createIcons(); filterMatrix(); }
        function filterMatrix() { const input = document.getElementById('searchBrand').value.toUpperCase(); document.querySelectorAll('.brand-card').forEach(card => { const brand = card.getAttribute('data-brand').toUpperCase(); const hasMatchingModel = globalMatrixData.some(m => m.brand.toUpperCase() === brand && m.model.toUpperCase().includes(input) ); card.style.display = (brand.includes(input) || hasMatchingModel) ? 'flex' : 'none'; }); }
        function getPartIcon(partType) { if(!partType) return 'tool'; const pt = partType.toLowerCase(); if(pt.includes('lcd') || pt.includes('screen')) return 'monitor'; if(pt.includes('battery') || pt.includes('bateri')) return 'battery'; if(pt.includes('charging') || pt.includes('port')) return 'zap'; if(pt.includes('motherboard') || pt.includes('cpu')) return 'cpu'; return 'tool'; }
        function openBrandDetails(brand) { document.getElementById('brandDetailsTitle').innerText = brand; const container = document.getElementById('brandDetailsList'); container.innerHTML = ''; globalMatrixData.filter(m => m.brand.toUpperCase() === brand).forEach(m => { const iconName = getPartIcon(m.partType); container.innerHTML += `<div class="bg-slate-50 border border-slate-200/60 rounded-[1.2rem] p-4 flex justify-between items-center group"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shrink-0"><i data-lucide="${iconName}" class="w-4 h-4"></i></div><div><h4 class="text-[13px] font-black text-slate-800">${m.model}</h4><div class="flex gap-2 mt-1.5 flex-wrap"><span class="text-[9px] font-bold text-slate-500 bg-white border border-slate-200 px-2 py-0.5 rounded-md uppercase tracking-wider">${m.partType || m.grade}</span><span class="text-[9px] font-black text-emerald-600 bg-emerald-50 border border-emerald-100 px-2 py-0.5 rounded-md font-num">RM ${parseFloat(m.price).toFixed(2)}</span></div></div></div><button onclick="deleteMatrix('${m.id}')" class="w-10 h-10 bg-white border border-rose-100 hover:bg-rose-50 text-rose-500 rounded-[1rem] flex items-center justify-center tap-effect transition-colors shadow-sm shrink-0"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`; }); lucide.createIcons(); toggleModal(true, true); const m = document.getElementById('brandDetailsModal'); m.classList.remove('hidden'); requestAnimationFrame(() => m.classList.add('active')); }
        function closeBrandDetails() { toggleModal(false, true); const m = document.getElementById('brandDetailsModal'); m.classList.remove('active'); setTimeout(() => m.classList.add('hidden'), 400); }
        function saveNewMatrix() { const brand = document.getElementById('matBrand').value.trim(); const model = document.getElementById('matModel').value.trim(); const partType = document.getElementById('matPartType').value; const grade = document.getElementById('matGrade').value.trim() || '-'; const price = document.getElementById('matPrice').value.trim(); if (!brand || !model || !price) { return showToast("Sila isi semua maklumat mandatori!", "error"); } globalMatrixData.unshift({ id: Date.now().toString(), brand, model, partType, grade, price: parseFloat(price), createdAt: Date.now() }); setLS('nx_matrix', globalMatrixData); showToast("Matriks harga ditambah!"); closeMatrixModal(); loadPricingMatrix(); }
        function deleteMatrix(id) { if(confirm("Padam matriks harga ini?")) { globalMatrixData = globalMatrixData.filter(x => x.id !== id); setLS('nx_matrix', globalMatrixData); showToast("Matriks dipadam."); closeBrandDetails(); loadPricingMatrix(); } }
    </script>
</body>
</html>
